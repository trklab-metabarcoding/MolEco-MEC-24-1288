{
  "hash": "1ab440aacc17d4e41598420afa2658be",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Continent-scale barcode coverage of lodgepole pine and big sagebrush\"\nformat: html\n---\n\n\n\n\nThis notebook will pull specimen records for two selected examples to highlight the effect of local sampling on global coverage.\n\n**NOTE:** Make sure GDAL is installed on the system you are running the notebooks from. This may require setting the \"PROJ_LIB\" and \"GDAL_HOME\" environment variables for your system.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## First check for the required packages, install if needed, and load the libraries.\nif (!requireNamespace(\"BiocManager\", quietly = TRUE))\n    install.packages(\"BiocManager\")\n\nBiocManager::install(\"sangerseqR\")\nremotes::install_github(\"ropensci/bold\")\nremotes::install_github(\"ropensci/taxize\")\n\nif (!require(\"pacman\")) install.packages(\"pacman\")\npacman::p_load(maps, ggplot2, dplyr, countrycode, rgbif, data.table, raster, mapproj, sf, terra, raster)\n```\n:::\n\n\n\n\n## Figure 2A-B. Get species keys for maps of *Pinus contorta* and *Artemisia tridentata* occurrences.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Using t.mean raster layer created above with worldclim: Change t.mean so that all cells have zero values \n\nt.mean.files <- list.files(\"../data/wc2.1_10m_tavg/\", \".tif\", full.names=TRUE)\n\nt.mean.files <- list.files(\"../data/wc2.1_10m_tavg/\", \".tif\", full.names=TRUE)\nt.mean <- terra::rast(t.mean.files)\nt.mean <- terra::app(t.mean, fun = mean, na.rm = TRUE)\nt.mean.addvalues <- t.mean\nt.mean.addvalues[!is.na(terra::values(t.mean.addvalues))] <- 0\nterra::plot(t.mean.addvalues)\n```\n\n::: {.cell-output-display}\n![](geocov_ynp_selected_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n\n```{.r .cell-code}\nstr(t.mean.addvalues)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nS4 class 'SpatRaster' [package \"terra\"]\n```\n\n\n:::\n\n```{.r .cell-code}\n#terra::plot(t.mean.addvalues) \nt.mean.addvalues\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \ndimensions  : 1080, 2160, 1  (nrow, ncol, nlyr)\nresolution  : 0.1666667, 0.1666667  (x, y)\nextent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)\ncoord. ref. : lon/lat WGS 84 (EPSG:4326) \nsource(s)   : memory\nname        : mean \nmin value   :    0 \nmax value   :    0 \n```\n\n\n:::\n\n```{.r .cell-code}\nt.mean.addvalues_extent_use <- terra::ext(t.mean.addvalues)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get taxon keys from GBIF\nkey_artemisia_tridentata <- name_suggest(q='Artemisia tridentata', rank='species')\nkey_artemisia_tridentata\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRecords returned [2] \nNo. unique hierarchies [0] \nArgs [q=Artemisia tridentata, limit=100, rank=species, fields1=key,\n     fields2=canonicalName, fields3=rank] \n# A tibble: 2 × 3\n      key canonicalName        rank   \n    <int> <chr>                <chr>  \n1 9396703 Artemisia tridentata SPECIES\n2 3121335 Artemisia tridentata SPECIES\n```\n\n\n:::\n\n```{.r .cell-code}\nkey_pinus_contorta <- name_suggest(q='Pinus contorta', rank='species')\nkey_pinus_contorta\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRecords returned [4] \nNo. unique hierarchies [0] \nArgs [q=Pinus contorta, limit=100, rank=species, fields1=key,\n     fields2=canonicalName, fields3=rank] \n# A tibble: 4 × 3\n      key canonicalName           rank   \n    <int> <chr>                   <chr>  \n1 5285750 Pinus contorta          SPECIES\n2 8405446 Pinus contorta          SPECIES\n3 7617264 Pinus contorta          SPECIES\n4 3908060 Lupinus pinus-contortae SPECIES\n```\n\n\n:::\n:::\n\n\n\n\n## Figure 2A: Map of *Pinus contorta* GBIF records\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Use occ_search() to query gbif records \nPINCON_occurrences_2 <- occ_search(taxonKey = 5285750, limit = 50000) # number found: 41,033\nhead(PINCON_occurrences_2, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$meta\n$meta$offset\n[1] 41100\n\n$meta$limit\n[1] 223\n\n$meta$endOfRecords\n[1] TRUE\n\n$meta$count\n[1] 41323\n\n\n$hierarchy\n$hierarchy[[1]]\n            name     key    rank\n1        Plantae       6 kingdom\n2   Tracheophyta 7707728  phylum\n3      Pinopsida     194   class\n4        Pinales     640   order\n5       Pinaceae    3925  family\n6          Pinus 2684241   genus\n7 Pinus contorta 5285750 species\n```\n\n\n:::\n\n```{.r .cell-code}\n# Count matches: 15336\nPINCON_occurrences_2_df <- data.frame(PINCON_occurrences_2$data) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Obtain coordinate data and project to desired CRS \nPinusSP <- data.frame(x_coords = PINCON_occurrences_2_df$decimalLongitude, y_coords = PINCON_occurrences_2_df$decimalLatitude) \nhead(PinusSP, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   x_coords y_coords\n1 -123.9814 49.15059\n2 -117.5496 48.30912\n```\n\n\n:::\n\n```{.r .cell-code}\nPinusSP <- terra::vect(PinusSP, geom=c(\"x_coords\", \"y_coords\"), crs=\"epsg:4326\")  # WGS84\nhead(PinusSP, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ndata frame with 0 columns and 0 rows\n```\n\n\n:::\n\n```{.r .cell-code}\n# Check objects for plotting\nhead(t.mean.addvalues, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mean\n1   NA\n2   NA\n```\n\n\n:::\n\n```{.r .cell-code}\nPinusSP_raster <- t.mean.addvalues\n\n# Extract cell numbers where coordinates match\nmatching_cells <- terra::cellFromXY(PinusSP_raster, terra::crds(PinusSP))\n\n# Set the values in PinusSP_raster to 1 where coordinates match\nPinusSP_raster[matching_cells] <- 1\nhead(PinusSP_raster, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mean\n1    1\n2   NA\n```\n\n\n:::\n\n```{.r .cell-code}\nterra::plot(PinusSP_raster)\n```\n\n::: {.cell-output-display}\n![](geocov_ynp_selected_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\nPinusSP_raster_dfpoints <- terra::as.points(PinusSP_raster)\n\n# Convert to data frame\nPinusSP_raster_df <- as.data.frame(PinusSP_raster_dfpoints, geom=\"XY\")\nhead(PinusSP_raster_df, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mean          x        y\n1    1 -179.91667 89.91667\n2    0  -38.91667 83.58333\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot using ggplot \nPinusSP_raster_df <- PinusSP_raster_df[PinusSP_raster_df$mean > 0, ]\n#PinusSP_raster_df\n\n# ggplot wrapper for world map \nworld_map <- map_data(\"world\") #ggplot wrapper of map()\nnorth_america_map <- subset(world_map, region == \"Mexico\" | region == \"Canada\" | region == \"USA\")\nhead(north_america_map, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           long      lat group order region    subregion\n14759 -59.78760 43.93960   245 14759 Canada Sable Island\n14760 -59.92227 43.90391   245 14760 Canada Sable Island\n```\n\n\n:::\n\n```{.r .cell-code}\n#Yellowstone outline\naoi_boundary_YNP <- sf::st_read(\"../data/YellowstonePark/YellowstonePark1995.shp\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `YellowstonePark1995' from data source \n  `/Users/tdivoll/Projects/Kartzinel/MolEco-MEC-24-1288/data/YellowstonePark/YellowstonePark1995.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 1 feature and 4 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 469695.4 ymin: -12706.41 xmax: 573531.9 ymax: 96658.52\nProjected CRS: NAD83 / Montana\n```\n\n\n:::\n\n```{.r .cell-code}\naoi_boundary_YNP #examine features\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 1 feature and 4 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 469695.4 ymin: -12706.41 xmax: 573531.9 ymax: 96658.52\nProjected CRS: NAD83 / Montana\n        AREA PERIMETER AB67_ AB67_ID                       geometry\n1 8842796032  447129.5     2     649 POLYGON ((559728.7 88811.52...\n```\n\n\n:::\n\n```{.r .cell-code}\nst_crs(aoi_boundary_YNP) #check coordinate system \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoordinate Reference System:\n  User input: NAD83 / Montana \n  wkt:\nPROJCRS[\"NAD83 / Montana\",\n    BASEGEOGCRS[\"NAD83\",\n        DATUM[\"North American Datum 1983\",\n            ELLIPSOID[\"GRS 1980\",6378137,298.257222101,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4269]],\n    CONVERSION[\"SPCS83 Montana zone (meters)\",\n        METHOD[\"Lambert Conic Conformal (2SP)\",\n            ID[\"EPSG\",9802]],\n        PARAMETER[\"Latitude of false origin\",44.25,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8821]],\n        PARAMETER[\"Longitude of false origin\",-109.5,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8822]],\n        PARAMETER[\"Latitude of 1st standard parallel\",49,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8823]],\n        PARAMETER[\"Latitude of 2nd standard parallel\",45,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8824]],\n        PARAMETER[\"Easting at false origin\",600000,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8826]],\n        PARAMETER[\"Northing at false origin\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8827]]],\n    CS[Cartesian,2],\n        AXIS[\"easting (X)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"northing (Y)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Engineering survey, topographic mapping.\"],\n        AREA[\"United States (USA) - Montana - counties of Beaverhead; Big Horn; Blaine; Broadwater; Carbon; Carter; Cascade; Chouteau; Custer; Daniels; Dawson; Deer Lodge; Fallon; Fergus; Flathead; Gallatin; Garfield; Glacier; Golden Valley; Granite; Hill; Jefferson; Judith Basin; Lake; Lewis and Clark; Liberty; Lincoln; Madison; McCone; Meagher; Mineral; Missoula; Musselshell; Park; Petroleum; Phillips; Pondera; Powder River; Powell; Prairie; Ravalli; Richland; Roosevelt; Rosebud; Sanders; Sheridan; Silver Bow; Stillwater; Sweet Grass; Teton; Toole; Treasure; Valley; Wheatland; Wibaux; Yellowstone.\"],\n        BBOX[44.35,-116.07,49.01,-104.04]],\n    ID[\"EPSG\",32100]]\n```\n\n\n:::\n\n```{.r .cell-code}\naoi_boundary_YNP_WGS84 <- st_transform(aoi_boundary_YNP,CRS(\"+proj=longlat +datum=WGS84\")) #choose a projection and datum that every spatial object we add to the map will be converted to before plotting\nst_crs(aoi_boundary_YNP_WGS84) #check coordinate system to ensure projection worked\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoordinate Reference System:\n  User input: GEOGCRS[\"unknown\",\n    DATUM[\"World Geodetic System 1984\",\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ID[\"EPSG\",6326]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433],\n        ID[\"EPSG\",8901]],\n    CS[ellipsoidal,2],\n        AXIS[\"longitude\",east,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]],\n        AXIS[\"latitude\",north,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]]] \n  wkt:\nGEOGCRS[\"unknown\",\n    DATUM[\"World Geodetic System 1984\",\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ID[\"EPSG\",6326]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433],\n        ID[\"EPSG\",8901]],\n    CS[ellipsoidal,2],\n        AXIS[\"longitude\",east,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]],\n        AXIS[\"latitude\",north,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]]]\n```\n\n\n:::\n\n```{.r .cell-code}\naoi_boundary_YNP_WGS84 #re examine features\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 1 feature and 4 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -111.1543 ymin: 44.13245 xmax: -109.8339 ymax: 45.10785\nGeodetic CRS:  GEOGCRS[\"unknown\",\n    DATUM[\"World Geodetic System 1984\",\n        ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n            LENGTHUNIT[\"metre\",1]],\n        ID[\"EPSG\",6326]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433],\n        ID[\"EPSG\",8901]],\n    CS[ellipsoidal,2],\n        AXIS[\"longitude\",east,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]],\n        AXIS[\"latitude\",north,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433,\n                ID[\"EPSG\",9122]]]]\n        AREA PERIMETER AB67_ AB67_ID                       geometry\n1 8842796032  447129.5     2     649 POLYGON ((-110.0112 45.0478...\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Plot \ncombtab <- read.csv(\"../data/combtab.csv\")\ncombtab_Pincon <- subset(combtab, species_name == \"Pinus contorta\")\naoi_boundary_YNP_WGS84_df <- as.data.frame(aoi_boundary_YNP_WGS84, xy = TRUE)\npinusmap2 <- ggplot() + \n  theme_classic() +\n  geom_tile(data = PinusSP_raster_df, aes(x, y, fill = mean)) + \n  geom_map(data = north_america_map, \n           map = north_america_map, \n           aes(map_id = region), fill = \"NA\", color = \"lightgray\", size = 0.2) + \n  scale_fill_viridis_c(na.value = \"white\", option = \"viridis\", direction = 1, begin =0.6) +\n  xlab(\"\") + ylab(\"\") + \n  scale_y_continuous(breaks = seq(-15, 75, 15), limits = c(20, 70)) +\n  scale_x_continuous(breaks = seq(-160, -60, 40), limits = c(-165, -50)) +\n  theme(legend.position = \"none\") +\n  geom_point(data = combtab_Pincon, \n             aes(x = lon, y = lat), pch = 3, size = 3, stroke = 0.9, color = alpha(\"black\", 0.9)) +\n  geom_sf(data = aoi_boundary_YNP_WGS84, fill = \"transparent\", lwd = 0.25, color = \"blue\")\npinusmap2\n```\n\n::: {.cell-output-display}\n![](geocov_ynp_selected_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#ggsave(\"pinusmap20240624_1.pdf\", pinusmap2, width = 20, height = 8, units = \"cm\")\n```\n:::\n\n\n\n\n## Figure 2B: Map of *Artemisia tridentata* gbif records\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Use occ_search() to query GBIF records \nArtTri_occurrences_2 <- occ_search(taxonKey = 9396703, limit = 20000) #16,738 found\nhead(ArtTri_occurrences_2, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$meta\n$meta$offset\n[1] 19200\n\n$meta$limit\n[1] 65\n\n$meta$endOfRecords\n[1] TRUE\n\n$meta$count\n[1] 19265\n\n\n$hierarchy\n$hierarchy[[1]]\n                  name     key    rank\n1              Plantae       6 kingdom\n2         Tracheophyta 7707728  phylum\n3        Magnoliopsida     220   class\n4            Asterales     414   order\n5           Asteraceae    3065  family\n6            Artemisia 3120641   genus\n7 Artemisia tridentata 9396703 species\n```\n\n\n:::\n\n```{.r .cell-code}\n# Count matches\nArtTri_occurrences_df <- data.frame(ArtTri_occurrences_2$data) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Obtain coordinate data and project to desired CRS \nArtemisiaSP <- data.frame(x_coords = ArtTri_occurrences_df$decimalLongitude, y_coords = ArtTri_occurrences_df$decimalLatitude) \nhead(ArtemisiaSP, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   x_coords y_coords\n1 -112.2500 41.05834\n2 -112.2562 41.03242\n```\n\n\n:::\n\n```{.r .cell-code}\nArtemisiaSP <- subset(ArtemisiaSP, x_coords !=\"\")\n\nArtemisiaSP <- terra::vect(ArtemisiaSP, geom=c(\"x_coords\", \"y_coords\"), crs=\"epsg:4326\")\n\n\n# Check objects for plotting\nhead(t.mean.addvalues, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mean\n1   NA\n2   NA\n```\n\n\n:::\n\n```{.r .cell-code}\nArtemisiaSP_raster <- t.mean.addvalues\n\n# Extract cell numbers where coordinates match\nmatching_cells <- terra::cellFromXY(ArtemisiaSP_raster, terra::crds(ArtemisiaSP))\n\n# Set the values in ArtemisiaSP_raster to 1 where coordinates match\nArtemisiaSP_raster[matching_cells] <- 1\nhead(ArtemisiaSP_raster, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mean\n1   NA\n2   NA\n```\n\n\n:::\n\n```{.r .cell-code}\nterra::plot(ArtemisiaSP_raster)\n```\n\n::: {.cell-output-display}\n![](geocov_ynp_selected_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\nArtemisiaSP_raster_dfpoints <- terra::as.points(ArtemisiaSP_raster)\n\n# Convert to data frame\nArtemisiaSP_raster_df <- as.data.frame(ArtemisiaSP_raster_dfpoints, geom=\"XY\")\nhead(ArtemisiaSP_raster_df, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  mean         x        y\n1    0 -38.91667 83.58333\n2    0 -38.75000 83.58333\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot using ggplot \nArtemisiaSP_raster_df <- subset(ArtemisiaSP_raster_df, mean > 0)\nhead(ArtemisiaSP_raster_df, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       mean         x        y\n207738    1 -122.0833 52.08333\n209104    1 -122.5833 51.91667\n```\n\n\n:::\n\n```{.r .cell-code}\n#Plot\ncombtab_Arttri <- subset(combtab, species_name == \"Artemisia tridentata\")\nArtemisiamap3 <- ggplot() + \n  theme_classic() +\n  geom_tile(data = ArtemisiaSP_raster_df, aes(x, y, fill = mean)) + \n  geom_map(data = north_america_map, map = north_america_map, aes(map_id = region), fill = \"NA\", color = \"lightgray\", size = 0.2) + \n  scale_fill_viridis_c(na.value = \"white\", option = \"inferno\", direction = -1, begin = 0.5) +\n  xlab(\"\") + ylab(\"\") + \n   scale_y_continuous(breaks = seq(-15, 75, 15), limits = c(20, 70)) +\n  scale_x_continuous(breaks = seq(-160, -60, 40), limits = c(-165, -50)) +\n  theme(legend.position = \"none\") +\n  geom_point(data = combtab_Arttri, aes(x = lon, y = lat), pch = 8, size = 3, stroke = 0.9, color = alpha(\"black\", 0.9)) + geom_sf(data = aoi_boundary_YNP_WGS84, fill = \"transparent\", lwd = 0.25, color = \"blue\")\nArtemisiamap3\n```\n\n::: {.cell-output-display}\n![](geocov_ynp_selected_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#ggsave(\"Artemisiamap4_20240626_1.pdf\", Artemisiamap3, width = 20, height = 8, units = \"cm\")\n```\n:::\n",
    "supporting": [
      "geocov_ynp_selected_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}